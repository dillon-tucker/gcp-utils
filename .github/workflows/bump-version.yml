name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version_part:
        description: 'Version part to bump'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bump2version
        run: |
          python -m pip install --upgrade pip
          pip install bump2version

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        run: |
          # Get current version
          CURRENT_VERSION=$(grep 'current_version' .bumpversion.cfg | cut -d' ' -f3)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Bump version
          bump2version ${{ inputs.version_part }} --allow-dirty

          # Get new version
          NEW_VERSION=$(grep 'current_version' .bumpversion.cfg | cut -d' ' -f3)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped version from $CURRENT_VERSION to $NEW_VERSION"

      - name: Push changes
        run: |
          git push origin master --follow-tags

      - name: Create release notes
        id: release_notes
        run: |
          cat << EOF > release_notes.md
          ## What's Changed

          Version bump: ${{ steps.bump.outputs.current_version }} â†’ ${{ steps.bump.outputs.new_version }}

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for detailed changes.

          ## Installation

          \`\`\`bash
          pip install gcp-utils==${{ steps.bump.outputs.new_version }}
          \`\`\`

          For specific GCP services:
          \`\`\`bash
          pip install gcp-utils[storage,firestore]==${{ steps.bump.outputs.new_version }}
          \`\`\`
          EOF

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.bump.outputs.new_version }}" \
            --title "v${{ steps.bump.outputs.new_version }}" \
            --notes-file release_notes.md \
            --draft=false

      - name: Summary
        run: |
          echo "## Version Bumped Successfully! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Version:** ${{ steps.bump.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version:** ${{ steps.bump.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release:** https://github.com/${{ github.repository }}/releases/tag/v${{ steps.bump.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The package will be automatically published to PyPI shortly." >> $GITHUB_STEP_SUMMARY
